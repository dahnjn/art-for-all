<!DOCTYPE html>
<html lang="en">
<head>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ART for ALL</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#fff;min-height:100vh;padding:40px 20px;color:#1a1a1a}
.container{max-width:1400px;margin:0 auto}
header{text-align:center;margin-bottom:50px;border-bottom:1px solid #e0e0e0;padding-bottom:30px}
h1{font-size:2rem;font-weight:300;letter-spacing:0.3em;text-transform:uppercase;margin-bottom:25px;color:#000}
.controls{display:flex;flex-direction:column;align-items:center;gap:20px}
.search-box{position:relative;width:100%;max-width:400px}
.search-box input{width:100%;padding:12px 15px 12px 40px;border:1px solid #ccc;background:#fafafa;color:#333;font-size:0.9rem;font-family:inherit;outline:none}
.search-box input:focus{border-color:#000}
.search-box::before{content:"âŒ•";position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#999;font-size:1.1rem}
.filter-row{display:flex;gap:5px;flex-wrap:wrap;justify-content:center}
.filter-tag{padding:8px 16px;border:1px solid #ddd;background:#fff;color:#666;cursor:pointer;font-size:0.75rem;font-family:inherit;text-transform:uppercase;letter-spacing:0.1em;transition:all 0.2s}
.filter-tag:hover{border-color:#000;color:#000}
.filter-tag.active{background:#000;color:#fff;border-color:#000}
.sort-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center}
.sort-row label{color:#999;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em}
.sort-row select{padding:8px 12px;border:1px solid #ccc;background:#fff;color:#333;font-family:inherit;font-size:0.8rem}
.results-count{color:#999;text-align:center;margin-bottom:20px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.1em}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
.art-card{background:#fff;border:6px solid #000;height:475px;display:flex;flex-direction:column;transition:box-shadow 0.3s;position:relative}
.art-card:hover{box-shadow:0 4px 20px rgba(0,0,0,0.1)}
.art-card.hidden{display:none}
.card-header{padding:15px;background:#fff;border-bottom:1px solid #eee}
.artwork-title{color:#000;font-size:0.85rem;font-weight:700;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.artist-name{color:#666;font-size:0.8rem;font-weight:400}
.artwork-meta{color:#999;font-size:0.7rem;margin-top:4px;text-transform:uppercase;letter-spacing:0.05em}
.image-container{flex:1;background:#f5f5f5;display:flex;align-items:center;justify-content:center;padding:15px;overflow:hidden}
.image-container img{max-width:100%;max-height:100%;object-fit:contain}
.card-footer{padding:10px 15px;background:#fafafa;border-top:1px solid #eee}
.category-row{display:flex;justify-content:center;gap:5px;margin-bottom:8px}
.category-tag{padding:4px 10px;background:#f0f0f0;color:#666;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.05em}
.ticket-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.ticket-chip{display:flex;justify-content:space-between;padding:4px 8px;border-radius:2px;font-size:0.65rem}
.ticket-city{font-weight:600;text-transform:uppercase}
.ticket-price{font-weight:400}
.city-newyork{background:#FFE5E5;color:#B91C1C}.city-london{background:#E0E7FF;color:#3730A3}.city-paris{background:#FEF3C7;color:#92400E}
.city-dubai{background:#DBEAFE;color:#1E40AF}.city-capetown{background:#D1FAE5;color:#065F46}.city-mexicocity{background:#FCE7F3;color:#9F1239}
.city-saopaulo{background:#F3E8FF;color:#6B21A8}.city-tokyo{background:#FED7AA;color:#9A3412}.city-shanghai{background:#E0F2FE;color:#075985}
.add-btn{position:absolute;top:10px;right:10px;width:32px;height:32px;background:#000;color:#fff;border:none;font-size:1.5rem;font-weight:300;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:2;border-radius:50%;line-height:1}
.add-btn:hover{background:#333}
.team-badge{position:absolute;top:10px;right:50px;padding:6px 12px;font-size:0.7rem;font-weight:700;border-radius:4px;z-index:2;display:flex;align-items:center;gap:6px;text-transform:uppercase}
.team-badge.team-1{background:#E94235;color:#fff}
.team-badge.team-2{background:#FBBC04;color:#000}
.team-badge.team-3{background:#4285F4;color:#fff}
.team-badge.team-4{background:#0F9D58;color:#fff}
.team-badge .remove{cursor:pointer;font-weight:bold;opacity:0.7;padding:0 4px}
.team-badge .remove:hover{opacity:1}
.rounds-input{width:60px;padding:5px;margin-left:10px;border:1px solid #444;background:#222;color:#fff;font-family:'Courier New',monospace}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:100;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal-content{background:#fff;max-width:600px;max-height:90vh;overflow:auto;position:relative;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.modal-close{position:absolute;top:10px;right:10px;width:30px;height:30px;border:2px solid #333;background:#fff;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:101}
.modal-close:hover{background:#f0f0f0}
.map-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:200;display:none;flex-direction:column}
.map-modal.show{display:flex}
.map-header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:#111;border-bottom:1px solid #333}
.map-title{color:#fff;font-family:'Courier New',monospace;font-size:1.2rem}
.map-close{background:#333;color:#fff;border:none;padding:8px 16px;cursor:pointer;font-family:inherit}
.map-content{flex:1;display:flex;position:relative;overflow:hidden}
.map-area{flex:1;position:relative;background:#000;display:flex;align-items:center;justify-content:center;padding:20px}
.map-container{position:relative;width:100%;max-width:1200px;height:100%;max-height:800px}
svg.map-svg{width:100%;height:100%}
.city-circle{cursor:pointer;transition:all 0.3s}
.city-circle:hover{filter:brightness(1.3)}
.city-label{fill:#fff;font-family:'Courier New',monospace;font-size:18px;text-anchor:middle;pointer-events:none;font-weight:bold}
.city-pop-label{fill:#888;font-family:'Courier New',monospace;font-size:14px;text-anchor:middle;pointer-events:none;font-weight:bold}
.connection-line{stroke:#333;stroke-width:2}
.team-marker{transition:all 0.3s;cursor:pointer}
.team-marker:hover{opacity:0.8}
.starting-position{fill:#666;stroke:#999;stroke-width:2}
.sidebar{width:320px;background:#111;padding:20px;overflow-y:auto;border-left:1px solid #333}
.sidebar h3{color:#fff;font-size:0.9rem;margin-bottom:15px;text-transform:uppercase;letter-spacing:0.1em}
.round-info{background:#222;padding:15px;margin-bottom:15px;border-radius:4px}
.round-info label{color:#888;font-size:0.75rem;display:block;margin-bottom:5px}
.round-info span{color:#fff;font-size:1.2rem;font-weight:bold}
.team-panel{background:#222;padding:15px;margin-bottom:10px;border-radius:4px;border-left:4px solid}
.team-panel.team-1{border-left-color:#E94235}
.team-panel.team-2{border-left-color:#FBBC04}
.team-panel.team-3{border-left-color:#4285F4}
.team-panel.team-4{border-left-color:#0F9D58}
.team-panel h4{color:#fff;font-size:0.85rem;margin-bottom:10px}
.team-panel select{width:100%;padding:8px;background:#333;color:#fff;border:1px solid #444;margin-bottom:8px;font-family:'Courier New',monospace}
.team-stat{display:flex;justify-content:space-between;color:#ccc;font-size:0.75rem;margin-top:5px;font-family:'Courier New',monospace}
.game-controls{padding:15px;background:#222;border-radius:4px;margin-bottom:15px}
.game-controls button{width:100%;padding:10px;margin-bottom:8px;background:#0F9D58;color:#fff;border:none;cursor:pointer;font-family:'Courier New',monospace;font-weight:bold;font-size:0.85rem}
.game-controls button:hover{background:#0d8549}
#resetGame{background:#E94235}
#resetGame:hover{background:#c23629}
#saveGame:hover{background:#3367d6}
#loadGame:hover{background:#f9ab00}
.log-container{background:#222;padding:15px;border-radius:4px;max-height:300px;overflow-y:auto}
.log-container h3{color:#fff;font-size:0.85rem;margin-bottom:10px;text-transform:uppercase}
.log-entry{color:#ccc;font-size:0.75rem;margin-bottom:5px;font-family:'Courier New',monospace;padding:5px;background:#1a1a1a;border-radius:2px}
</style>
</head>
<body>
<div class="container">
<header>
<h1>ART for ALL</h1>
<div class="controls">
<div class="search-box">
<input type="text" id="searchInput" placeholder="Search artworks...">
</div>
<div class="filter-row">
<button class="filter-tag active" data-category="all">All</button>
<button class="filter-tag" data-category="painting">Painting</button>
<button class="filter-tag" data-category="sculpture">Sculpture</button>
<button class="filter-tag" data-category="installation">Installation</button>
<button class="filter-tag" data-category="photography">Photography</button>
</div>
<div class="sort-row">
<label>Sort by City:</label>
<select id="citySelect">
<option value="">None</option>
<option value="newyork">NYC</option>
<option value="london">LDN</option>
<option value="paris">PAR</option>
<option value="dubai">DXB</option>
<option value="capetown">CPT</option>
<option value="mexicocity">MEX</option>
<option value="saopaulo">SAO</option>
<option value="tokyo">TYO</option>
<option value="shanghai">SHA</option>
</select>
<select id="sortDirection">
<option value="high">High to Low</option>
<option value="low">Low to High</option>
</select>
</div>
<div class="sort-row">
<label>Filter by Team:</label>
<select id="teamFilter">
<option value="all">All Teams</option>
<option value="1">Team 1 (Red)</option>
<option value="2">Team 2 (Yellow)</option>
<option value="3">Team 3 (Blue)</option>
<option value="4">Team 4 (Green)</option>
<option value="unassigned">Unassigned</option>
</select>
</div>
</div>
<button id="mapBtn" style="margin-top:15px;padding:12px 30px;background:#000;color:#fff;border:none;font-family:inherit;font-size:0.85rem;letter-spacing:0.1em;cursor:pointer">MAP</button>
</header>
<div id="competitiveAnalysis" style="margin-bottom:30px;display:none">
<h2 style="text-align:center;font-size:1.2rem;margin-bottom:20px;text-transform:uppercase;letter-spacing:0.1em">Competitive Analysis</h2>
<div style="overflow-x:auto">
<table style="width:100%;border-collapse:collapse;font-size:0.85rem;font-family:'Courier New',monospace">
<thead>
<tr style="background:#000;color:#fff">
<th style="padding:12px;text-align:left">CITY</th>
<th style="padding:12px;text-align:center">TEAM 1</th>
<th style="padding:12px;text-align:center">TEAM 2</th>
<th style="padding:12px;text-align:center">TEAM 3</th>
<th style="padding:12px;text-align:center">TEAM 4</th>
</tr>
</thead>
<tbody id="analysisTableBody">
</tbody>
</table>
</div>
</div>
<div class="results-count" id="resultsCount">24 Works</div>
<div class="gallery" id="gallery"></div>
</div>

<div class="map-modal" id="mapModal">
<div class="map-header">
<div class="map-title">ART for ALL - TRAVEL MAP</div>
<div style="display:flex;align-items:center;gap:20px">
<label style="color:#888;font-size:0.8rem">Rounds:<input type="number" id="totalRounds" class="rounds-input" value="8" min="1" max="20"></label>
<button class="map-close" id="mapClose">âœ• CLOSE</button>
</div>
</div>
<div class="map-content">
<div class="map-area" id="mapArea">
<div class="map-container">
<svg class="map-svg" id="mapSvg" viewBox="0 0 1000 600">
<g id="connectionLines"></g>
<g id="citiesGroup"></g>
<g id="teamsGroup"></g>
</svg>
</div>
</div>
<div class="sidebar">
<div class="round-info">
<label>Current Round</label>
<span id="currentRound">1</span> / <span id="maxRounds">8</span>
</div>
<div class="scoreboard-container" style="background:#222;padding:15px;border-radius:4px;margin-bottom:20px">
<h3 style="color:#fff;font-size:0.9rem;margin-bottom:15px;text-transform:uppercase;letter-spacing:0.1em">Scoreboard</h3>
<div id="scoreboard"></div>
</div>
<div class="game-controls">
<button id="nextRound">NEXT ROUND â†’</button>
<button id="resetGame">âŸ² RESET GAME</button>
<button id="saveGame" style="background:#4285F4">ðŸ’¾ SAVE GAME</button>
<button id="loadGame" style="background:#FBBC04;color:#000">ðŸ“‚ LOAD GAME</button>
</div>
<h3>Team Destinations</h3>
<div class="team-panel team-1">
<h4>Team 1 (RED)</h4>
<select id="dest1"></select>
<div class="team-stat"><span>Ticket Value:</span><span id="tv1">$0</span></div>
<div class="team-stat"><span>Cash:</span><span id="cash1" style="font-weight:bold">$0</span></div>
<div class="team-stat"><span>Artworks:</span><span id="artcount1">0</span></div>
</div>
<div class="team-panel team-2">
<h4>Team 2 (YELLOW)</h4>
<select id="dest2"></select>
<div class="team-stat"><span>Ticket Value:</span><span id="tv2">$0</span></div>
<div class="team-stat"><span>Cash:</span><span id="cash2" style="font-weight:bold">$0</span></div>
<div class="team-stat"><span>Artworks:</span><span id="artcount2">0</span></div>
</div>
<div class="team-panel team-3">
<h4>Team 3 (BLUE)</h4>
<select id="dest3"></select>
<div class="team-stat"><span>Ticket Value:</span><span id="tv3">$0</span></div>
<div class="team-stat"><span>Cash:</span><span id="cash3" style="font-weight:bold">$0</span></div>
<div class="team-stat"><span>Artworks:</span><span id="artcount3">0</span></div>
</div>
<div class="team-panel team-4">
<h4>Team 4 (GREEN)</h4>
<select id="dest4"></select>
<div class="team-stat"><span>Ticket Value:</span><span id="tv4">$0</span></div>
<div class="team-stat"><span>Cash:</span><span id="cash4" style="font-weight:bold">$0</span></div>
<div class="team-stat"><span>Artworks:</span><span id="artcount4">0</span></div>
</div>
<div class="log-container">
<h3>Game Log</h3>
<div id="logEntries"></div>
</div>
</div>
</div>
</div>

<script>
// Artwork data will be inserted here
const artworks = [
  {title:"Infinity Mirrored Room",artist:"Yayoi Kusama",year:"2013",category:"installation",image:"https://dahnjn.github.io/art-for-all-images/installation_4.jpg",cities:{"newyork": 12, "london": 12, "paris": 12, "dubai": 12, "capetown": 12, "mexicocity": 12, "saopaulo": 12, "tokyo": 12, "shanghai": 4}},
  {title:"Cloud Gate",artist:"Anish Kapoor",year:"2006",category:"installation",image:"https://dahnjn.github.io/art-for-all-images/installation_1.jpg",cities:{"newyork": 12, "london": 12, "paris": 11, "dubai": 11, "capetown": 11, "mexicocity": 11, "saopaulo": 11, "tokyo": 10, "shanghai": 1}},
  {title:"The Scream",artist:"Edvard Munch",year:"1893",category:"painting",image:"https://dahnjn.github.io/art-for-all-images/painting_1.jpg",cities:{"newyork": 12, "london": 12, "paris": 12, "dubai": 11, "capetown": 10, "mexicocity": 8, "saopaulo": 6, "tokyo": 4, "shanghai": 5}},
  {title:"Forever Bicycles",artist:"Ai Weiwei",year:"2011",category:"installation",image:"https://dahnjn.github.io/art-for-all-images/installation_3.webp",cities:{"newyork": 8, "london": 8, "paris": 9, "dubai": 9, "capetown": 9, "mexicocity": 7, "saopaulo": 6, "tokyo": 12, "shanghai": 12}},
  {title:"The Persistence of Memory",artist:"Salvador DalÃ­",year:"1931",category:"painting",image:"https://dahnjn.github.io/art-for-all-images/painting_5.jpg",cities:{"newyork": 12, "london": 12, "paris": 11, "dubai": 10, "capetown": 9, "mexicocity": 7, "saopaulo": 5, "tokyo": 2, "shanghai": 2}},
  {title:"The Physical Impossibility",artist:"Damien Hirst",year:"1991",category:"sculpture",image:"https://dahnjn.github.io/art-for-all-images/sculpture_4.jpg",cities:{"newyork": 12, "london": 12, "paris": 11, "dubai": 10, "capetown": 8, "mexicocity": 7, "saopaulo": 6, "tokyo": 2, "shanghai": 2}},
  {title:"Earth Globe",artist:"Mona Hatoum",year:"2007",category:"installation",image:"https://dahnjn.github.io/art-for-all-images/installation_2.jpg",cities:{"newyork": 10, "london": 10, "paris": 10, "dubai": 9, "capetown": 8, "mexicocity": 8, "saopaulo": 7, "tokyo": 6, "shanghai": 2}},
  {title:"The Weather Project",artist:"Olafur Eliasson",year:"2003",category:"installation",image:"https://dahnjn.github.io/art-for-all-images/installation_6.jpg",cities:{"newyork": 11, "london": 11, "paris": 10, "dubai": 9, "capetown": 8, "mexicocity": 7, "saopaulo": 4, "tokyo": 0, "shanghai": 0}},
  {title:"Composition",artist:"Piet Mondrian",year:"1921",category:"painting",image:"https://dahnjn.github.io/art-for-all-images/painting_3.jpg",cities:{"newyork": 11, "london": 11, "paris": 10, "dubai": 9, "capetown": 8, "mexicocity": 6, "saopaulo": 5, "tokyo": 0, "shanghai": 0}},
  {title:"Balloon Dog",artist:"Jeff Koons",year:"1994",category:"sculpture",image:"https://dahnjn.github.io/art-for-all-images/sculpture_1.png",cities:{"newyork": 10, "london": 10, "paris": 9, "dubai": 8, "capetown": 7, "mexicocity": 6, "saopaulo": 5, "tokyo": 3, "shanghai": 2}},
  {title:"727-727",artist:"Takashi Murakami",year:"2006",category:"painting",image:"https://dahnjn.github.io/art-for-all-images/painting_4.webp",cities:{"newyork": 6, "london": 5, "paris": 5, "dubai": 7, "capetown": 6, "mexicocity": 5, "saopaulo": 4, "tokyo": 10, "shanghai": 12}},
  {title:"Sunflower Seeds",artist:"Ai Weiwei",year:"2010",category:"installation",image:"https://dahnjn.github.io/art-for-all-images/installation_5.jpg",cities:{"newyork": 8, "london": 8, "paris": 8, "dubai": 7, "capetown": 6, "mexicocity": 10, "saopaulo": 11, "tokyo": 1, "shanghai": 1}},
  {title:"The Two Fridas",artist:"Frida Kahlo",year:"1939",category:"painting",image:"https://dahnjn.github.io/art-for-all-images/painting_6.jpg",cities:{"newyork": 4, "london": 4, "paris": 4, "dubai": 3, "capetown": 3, "mexicocity": 12, "saopaulo": 12, "tokyo": 4, "shanghai": 4}},
  {title:"Pumpkin",artist:"Yayoi Kusama",year:"2022",category:"sculpture",image:"https://dahnjn.github.io/art-for-all-images/sculpture_2.jpg",cities:{"newyork": 4, "london": 4, "paris": 4, "dubai": 5, "capetown": 4, "mexicocity": 3, "saopaulo": 3, "tokyo": 11, "shanghai": 12}},
  {title:"A Bigger Splash",artist:"David Hockney",year:"1967",category:"painting",image:"https://dahnjn.github.io/art-for-all-images/painting_2.jpg",cities:{"newyork": 8, "london": 11, "paris": 10, "dubai": 8, "capetown": 6, "mexicocity": 4, "saopaulo": 3, "tokyo": 0, "shanghai": 0}},
  {title:"Maman",artist:"Louise Bourgeois",year:"1999",category:"sculpture",image:"https://dahnjn.github.io/art-for-all-images/sculpture_3_.jpg",cities:{"newyork": 10, "london": 11, "paris": 10, "dubai": 8, "capetown": 6, "mexicocity": 3, "saopaulo": 2, "tokyo": 0, "shanghai": 0}},
  {title:"Mobile",artist:"Alexander Calder",year:"1958",category:"sculpture",image:"https://dahnjn.github.io/art-for-all-images/sculpture_6.jpg",cities:{"newyork": 9, "london": 9, "paris": 9, "dubai": 8, "capetown": 7, "mexicocity": 5, "saopaulo": 3, "tokyo": 0, "shanghai": 0}},
  {title:"Migrant Mother",artist:"Dorothea Lange",year:"1936",category:"photography",image:"https://dahnjn.github.io/art-for-all-images/photograph_5.jpg",cities:{"newyork": 10, "london": 9, "paris": 8, "dubai": 7, "capetown": 5, "mexicocity": 1, "saopaulo": 0, "tokyo": 0, "shanghai": 0}},
  {title:"Earthrise",artist:"William Anders",year:"1968",category:"photography",image:"https://dahnjn.github.io/art-for-all-images/photograph_6.jpg",cities:{"newyork": 11, "london": 10, "paris": 9, "dubai": 7, "capetown": 3, "mexicocity": 0, "saopaulo": 0, "tokyo": 0, "shanghai": 0}},
  {title:"Atmosphere and Environment XII",artist:"Louise Nevelson",year:"1970",category:"sculpture",image:"https://dahnjn.github.io/art-for-all-images/sculpture_5_.jpg",cities:{"newyork": 9, "london": 9, "paris": 8, "dubai": 7, "capetown": 5, "mexicocity": 2, "saopaulo": 0, "tokyo": 0, "shanghai": 0}},
  {title:"Einstein Tongue",artist:"Arthur Sasse",year:"1951",category:"photography",image:"https://dahnjn.github.io/art-for-all-images/photograph_3.jpg",cities:{"newyork": 8, "london": 8, "paris": 7, "dubai": 5, "capetown": 2, "mexicocity": 0, "saopaulo": 0, "tokyo": 0, "shanghai": 0}},
  {title:"Last Barbary Lion",artist:"Unknown",year:"1925",category:"photography",image:"https://dahnjn.github.io/art-for-all-images/photograph_4.webp",cities:{"newyork": 7, "london": 7, "paris": 6, "dubai": 5, "capetown": 3, "mexicocity": 2, "saopaulo": 0, "tokyo": 0, "shanghai": 0}},
  {title:"First Flight",artist:"Wright Brothers",year:"1903",category:"photography",image:"https://dahnjn.github.io/art-for-all-images/photograph_1.jpg",cities:{"newyork": 6, "london": 6, "paris": 5, "dubai": 3, "capetown": 0, "mexicocity": 0, "saopaulo": 0, "tokyo": 0, "shanghai": 0}},
  {title:"Abbey Road",artist:"Iain Macmillan",year:"1969",category:"photography",image:"https://dahnjn.github.io/art-for-all-images/photograph_2.jpg",cities:{"newyork": 0, "london": 9, "paris": 0, "dubai": 0, "capetown": 0, "mexicocity": 0, "saopaulo": 0, "tokyo": 1, "shanghai": 0}},
];





const cities = ['newyork','london','paris','dubai','capetown','mexicocity','saopaulo','tokyo','shanghai'];
const cityNames = {newyork:'NYC',london:'LDN',paris:'PAR',dubai:'DXB',capetown:'CPT',mexicocity:'MEX',saopaulo:'SAO',tokyo:'TYO',shanghai:'SHA'};

const cityData = {
  start: {name:'START',pop:0,x:500,y:500,connections:['mexicocity','capetown']},
  newyork: {name:'NYC',pop:1500000,x:200,y:150,connections:['saopaulo','mexicocity','london']},
  london: {name:'LDN',pop:1250000,x:500,y:100,connections:['paris','newyork']},
  paris: {name:'PAR',pop:1000000,x:550,y:150,connections:['london','capetown','dubai']},
  dubai: {name:'DXB',pop:500000,x:750,y:250,connections:['paris','capetown','shanghai']},
  capetown: {name:'CPT',pop:500000,x:600,y:400,connections:['paris','dubai','shanghai','start']},
  mexicocity: {name:'MEX',pop:600000,x:150,y:350,connections:['newyork','saopaulo','tokyo','shanghai','start']},
  saopaulo: {name:'SAO',pop:900000,x:250,y:450,connections:['mexicocity','newyork']},
  tokyo: {name:'TYO',pop:800000,x:900,y:200,connections:['shanghai','mexicocity']},
  shanghai: {name:'SHA',pop:2000000,x:850,y:350,connections:['tokyo','mexicocity','dubai','capetown']}
};

let gameState = {
  round: 1,
  maxRounds: 8,
  teams: {
    1: {cash: 0, city: 'start', artworks: [], soldTo: {}}, // soldTo tracks % of each city this team has sold to
    2: {cash: 0, city: 'start', artworks: [], soldTo: {}},
    3: {cash: 0, city: 'start', artworks: [], soldTo: {}},
    4: {cash: 0, city: 'start', artworks: [], soldTo: {}}
  }
};


function updateCompetitiveAnalysis() {
  const tv = getTeamTicketValues();
  const cities = ['newyork', 'london', 'paris', 'dubai', 'capetown', 'mexicocity', 'saopaulo', 'tokyo', 'shanghai'];
  const cityDisplayNames = {
    newyork: 'New York',
    london: 'London', 
    paris: 'Paris',
    dubai: 'Dubai',
    capetown: 'Cape Town',
    mexicocity: 'Mexico City',
    saopaulo: 'SÃ£o Paulo',
    tokyo: 'Tokyo',
    shanghai: 'Shanghai'
  };
  
  const tableBody = document.getElementById('analysisTableBody');
  const analysis = document.getElementById('competitiveAnalysis');
  
  // Check if any team has artworks
  const hasArtworks = [1,2,3,4].some(t => gameState.teams[t].artworks.length > 0);
  
  if (!hasArtworks) {
    analysis.style.display = 'none';
    return;
  }
  
  analysis.style.display = 'block';
  
  tableBody.innerHTML = cities.map(city => {
    const values = [tv[1][city], tv[2][city], tv[3][city], tv[4][city]];
    const maxValue = Math.max(...values);
    const hasValues = values.some(v => v > 0);
    
    if (!hasValues) return ''; // Skip cities with no artworks
    
    const teamColors = ['#E94235', '#FBBC04', '#4285F4', '#0F9D58'];
    
    const cells = values.map((val, idx) => {
      if (val === 0) return '<td style="padding:12px;text-align:center;color:#ccc">â€”</td>';
      
      const isMax = val === maxValue && maxValue > 0;
      const rank = values.filter(v => v > val).length + 1;
      
      return `<td style="padding:12px;text-align:center;background:${isMax ? teamColors[idx] + '22' : 'transparent'};font-weight:${isMax ? 'bold' : 'normal'}">
        <div style="color:${teamColors[idx]};font-size:1rem">$${val}</div>
        <div style="color:#999;font-size:0.75rem">${getRankDisplay(rank, values)}</div>
      </td>`;
    }).join('');
    
    return `<tr style="border-bottom:1px solid #eee">
      <td style="padding:12px;font-weight:bold">${cityDisplayNames[city]}</td>
      ${cells}
    </tr>`;
  }).filter(row => row).join('');
}

function getRankDisplay(rank, values) {
  const nonZeroCount = values.filter(v => v > 0).length;
  if (nonZeroCount === 1) return 'â€”';
  
  const suffix = ['st', 'nd', 'rd', 'th'][rank > 3 ? 3 : rank - 1];
  return `${rank}${suffix}`;
}

function initGallery() {
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = artworks.map((art, idx) => `
    <div class="art-card" data-category="${art.category}" data-idx="${idx}">
      <div class="add-btn" data-idx="${idx}">+</div>
      <div class="team-badge-container" data-idx="${idx}"></div>
      <div class="card-header">
        <div class="artwork-title">${art.title}</div>
        <div class="artist-name">${art.artist}</div>
        <div class="artwork-meta">${art.year}</div>
      </div>
      <div class="image-container">
        <img src="${art.image}" style="max-width:100%;max-height:100%;object-fit:contain" alt="${art.title}">
      </div>
      <div class="card-footer">
        <div class="category-row"><span class="category-tag">${art.category}</span></div>
        <div class="ticket-grid">
          ${Object.entries(art.cities).map(([city,price]) => 
            `<div class="ticket-chip city-${city}"><span class="ticket-city">${cityNames[city]}</span><span class="ticket-price">$${price}</span></div>`
          ).join('')}
        </div>
        <div style="text-align:center;margin-top:8px;padding-top:8px;border-top:1px solid #ddd">
          <span style="font-size:0.7rem;color:#999;text-transform:uppercase;letter-spacing:0.05em">Total Value: </span>
          <span style="font-size:0.9rem;font-weight:bold;color:#000">$${Object.values(art.cities).reduce((a,b) => a+b, 0)}</span>
        </div>
      </div>
    </div>
  `).join('');
  
  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const idx = parseInt(btn.dataset.idx);
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;display:flex;align-items:center;justify-content:center';
      modal.innerHTML = `
        <div style="background:#fff;padding:30px;border-radius:8px;max-width:400px;width:90%">
          <h3 style="margin:0 0 20px 0;font-size:1.2rem">Assign Artwork</h3>
          <div style="margin-bottom:15px">
            <label style="display:block;margin-bottom:5px;font-weight:600;font-size:0.9rem">Team:</label>
            <select id="teamSelect" style="width:100%;padding:10px;font-size:1rem;border:2px solid #ddd">
              <option value="">Select Team</option>
              <option value="1">Team 1 (Red)</option>
              <option value="2">Team 2 (Yellow)</option>
              <option value="3">Team 3 (Blue)</option>
              <option value="4">Team 4 (Green)</option>
            </select>
          </div>
          <div style="margin-bottom:20px">
            <label style="display:block;margin-bottom:5px;font-weight:600;font-size:0.9rem">Purchase Price:</label>
            <div style="position:relative">
              <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1rem;color:#666">$</span>
              <input type="text" id="priceInput" placeholder="0" style="width:100%;padding:10px 10px 10px 25px;font-size:1rem;border:2px solid #ddd">
            </div>
          </div>
          <div style="display:flex;gap:10px">
            <button id="assignBtn" style="flex:1;padding:12px;background:#000;color:#fff;border:none;font-weight:600;cursor:pointer;font-size:1rem">ASSIGN</button>
            <button id="cancelBtn" style="flex:1;padding:12px;background:#fff;color:#000;border:2px solid #ddd;font-weight:600;cursor:pointer;font-size:1rem">CANCEL</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.getElementById('priceInput').focus();
      
      // Format price input with commas
      const priceInput = document.getElementById('priceInput');
      priceInput.addEventListener('input', (e) => {
        let val = e.target.value.replace(/[^0-9]/g, '');
        if (val) {
          val = parseInt(val).toLocaleString();
        }
        e.target.value = val;
      });
      
      document.getElementById('cancelBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      document.getElementById('assignBtn').addEventListener('click', () => {
        const teamNum = document.getElementById('teamSelect').value;
        const priceStr = document.getElementById('priceInput').value.replace(/[,$]/g, '');
        const price = priceStr === '' ? 0 : parseFloat(priceStr);
        
        if (!teamNum) {
          alert('Please select a team');
          return;
        }
        if (isNaN(price) || price < 0) {
          alert('Please enter a valid price (0 or greater)');
          return;
        }
        
        gameState.teams[teamNum].artworks.push({
          idx: idx,
          price: price,
          title: artworks[idx].title
        });
        gameState.teams[teamNum].cash -= price;
        
        const card = btn.closest('.art-card');
        card.dataset.team = 'TEAM ' + teamNum;
        
        const container = card.querySelector('.team-badge-container');
        container.innerHTML = `
          <div class="team-badge team-${teamNum}">
            <span>TEAM ${teamNum}</span>
            <span class="remove" data-idx="${idx}" data-team="${teamNum}">Ã—</span>
          </div>
        `;
        
        container.querySelector('.remove').addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm('Remove this artwork from Team ' + teamNum + '?')) {
            const artIdx = gameState.teams[teamNum].artworks.findIndex(a => a.idx === idx);
            if (artIdx !== -1) {
              const artwork = gameState.teams[teamNum].artworks[artIdx];
              gameState.teams[teamNum].cash += artwork.price;
              gameState.teams[teamNum].artworks.splice(artIdx, 1);
            }
            container.innerHTML = '';
            delete card.dataset.team;
            updateTeamDisplay();
            updateCompetitiveAnalysis();
          }
        });
        
        updateTeamDisplay();
        updateCompetitiveAnalysis();
        document.body.removeChild(modal);
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    });
  });
}

document.querySelectorAll('.filter-tag').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const category = btn.dataset.category;
    document.querySelectorAll('.art-card').forEach(card => {
      if (category === 'all' || card.dataset.category === category) {
        card.classList.remove('hidden');
      } else {
        card.classList.add('hidden');
      }
    });
  });
});

function applySortAndFilter() {
  const city = document.getElementById('citySelect').value;
  const direction = document.getElementById('sortDirection').value;
  const teamFilter = document.getElementById('teamFilter').value;
  const gallery = document.getElementById('gallery');
  const cards = Array.from(document.querySelectorAll('.art-card'));
  
  // Apply team filter
  cards.forEach(card => {
    const cardTeam = card.dataset.team ? card.dataset.team.replace('TEAM ', '') : 'unassigned';
    if (teamFilter === 'all') {
      card.classList.remove('hidden');
    } else if (teamFilter === 'unassigned') {
      card.classList.toggle('hidden', cardTeam !== 'unassigned');
    } else {
      card.classList.toggle('hidden', cardTeam !== teamFilter);
    }
  });
  
  // Apply sorting
  if (city) {
    cards.sort((a, b) => {
      const idxA = parseInt(a.dataset.idx);
      const idxB = parseInt(b.dataset.idx);
      const priceA = artworks[idxA].cities[city];
      const priceB = artworks[idxB].cities[city];
      
      if (direction === 'high') {
        return priceB - priceA;
      } else {
        return priceA - priceB;
      }
    });
  } else {
    // Default sort by index
    cards.sort((a, b) => parseInt(a.dataset.idx) - parseInt(b.dataset.idx));
  }
  
  // Re-append cards in sorted order
  cards.forEach(card => gallery.appendChild(card));
}

document.getElementById('citySelect').addEventListener('change', applySortAndFilter);
document.getElementById('sortDirection').addEventListener('change', applySortAndFilter);
document.getElementById('teamFilter').addEventListener('change', applySortAndFilter);

document.getElementById('searchInput').addEventListener('input', (e) => {
  const search = e.target.value.toLowerCase();
  document.querySelectorAll('.art-card').forEach(card => {
    const idx = parseInt(card.dataset.idx);
    const art = artworks[idx];
    const matches = art.title.toLowerCase().includes(search) || 
                   art.artist.toLowerCase().includes(search);
    card.classList.toggle('hidden', !matches);
  });
});

function initMap() {
  drawConnections();
  drawCities();
  drawTeams();
}

function drawConnections() {
  const linesGroup = document.getElementById('connectionLines');
  linesGroup.innerHTML = '';
  
  Object.entries(cityData).forEach(([cityKey, city]) => {
    city.connections.forEach(targetKey => {
      const target = cityData[targetKey];
      if (city.x < target.x || (city.x === target.x && city.y < target.y)) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', city.x);
        line.setAttribute('y1', city.y);
        line.setAttribute('x2', target.x);
        line.setAttribute('y2', target.y);
        line.setAttribute('class', 'connection-line');
        linesGroup.appendChild(line);
      }
    });
  });
}

function drawCities() {
  const citiesGroup = document.getElementById('citiesGroup');
  citiesGroup.innerHTML = '';
  
  Object.entries(cityData).forEach(([cityKey, city]) => {
    if (cityKey === 'start') {
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', city.x);
      circle.setAttribute('cy', city.y);
      circle.setAttribute('r', 25);
      circle.setAttribute('class', 'starting-position');
      citiesGroup.appendChild(circle);
      
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', city.x);
      label.setAttribute('y', city.y + 5);
      label.setAttribute('class', 'city-label');
      label.textContent = city.name;
      citiesGroup.appendChild(label);
    } else {
      const radius = Math.sqrt(city.pop / 10000) * 2;
      
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', city.x);
      circle.setAttribute('cy', city.y);
      circle.setAttribute('r', radius);
      circle.setAttribute('fill', '#4285F4');
      circle.setAttribute('class', 'city-circle');
      circle.setAttribute('data-city', cityKey);
      citiesGroup.appendChild(circle);
      
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', city.x);
      label.setAttribute('y', city.y - radius - 5);
      label.setAttribute('class', 'city-label');
      label.textContent = city.name;
      citiesGroup.appendChild(label);
      
      const popLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      popLabel.setAttribute('x', city.x);
      popLabel.setAttribute('y', city.y + radius + 15);
      popLabel.setAttribute('class', 'city-pop-label');
      popLabel.textContent = (city.pop / 1000000).toFixed(1) + 'M';
      citiesGroup.appendChild(popLabel);
    }
  });
}

function drawTeams() {
  const teamsGroup = document.getElementById('teamsGroup');
  teamsGroup.innerHTML = '';
  
  const teamColors = ['#E94235', '#FBBC04', '#4285F4', '#0F9D58'];
  
  for (let i = 1; i <= 4; i++) {
    const team = gameState.teams[i];
    const cityPos = cityData[team.city];
    
    const offset = (i - 2.5) * 24;
    const x = cityPos.x + offset;
    const y = cityPos.y;
    
    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    marker.setAttribute('class', `team-marker team-${i}`);
    marker.setAttribute('data-team', i);
    
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', x);
    circle.setAttribute('cy', y);
    circle.setAttribute('r', 12);
    circle.setAttribute('fill', teamColors[i-1]);
    circle.setAttribute('stroke', '#000');
    circle.setAttribute('stroke-width', '2');
    marker.appendChild(circle);
    
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', x);
    text.setAttribute('y', y + 5);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('font-size', '16');
    text.setAttribute('font-weight', 'bold');
    text.setAttribute('fill', i === 2 ? '#000' : '#fff');
    text.textContent = i;
    marker.appendChild(text);
    
    teamsGroup.appendChild(marker);
  }
}

function getTeamTicketValues() {
  const values = {1:{},2:{},3:{},4:{}};
  cities.forEach(city => {
    values[1][city] = 0;
    values[2][city] = 0;
    values[3][city] = 0;
    values[4][city] = 0;
  });
  
  document.querySelectorAll('.art-card').forEach(card => {
    const team = card.dataset.team;
    if (team && team !== 'undefined') {
      const teamNum = parseInt(team.replace('TEAM ',''));
      const idx = parseInt(card.dataset.idx);
      const art = artworks[idx];
      cities.forEach(city => {
        values[teamNum][city] += art.cities[city];
      });
    }
  });
  return values;
}

function populateDestinationDropdowns() {
  for (let i = 1; i <= 4; i++) {
    const select = document.getElementById(`dest${i}`);
    const currentCity = gameState.teams[i].city;
    const availableCities = cityData[currentCity].connections;
    
    select.innerHTML = '<option value="">Stay Here</option>' + 
      availableCities.filter(c => c !== 'start').map(cityKey => 
        `<option value="${cityKey}">${cityData[cityKey].name}</option>`
      ).join('');
  }
}

function updateTeamDisplay() {
  const tv = getTeamTicketValues();
  
  for (let i = 1; i <= 4; i++) {
    const dest = document.getElementById(`dest${i}`).value || gameState.teams[i].city;
    const ticketVal = dest !== 'start' ? tv[i][dest] || 0 : 0;
    document.getElementById(`tv${i}`).textContent = '$' + ticketVal;
    
    const cash = gameState.teams[i].cash;
    const cashEl = document.getElementById(`cash${i}`);
    cashEl.textContent = '$' + cash.toLocaleString();
    cashEl.style.color = cash < 0 ? '#E94235' : '#0F9D58';
    document.getElementById(`artcount${i}`).textContent = gameState.teams[i].artworks.length;
  }
  
  const teams = [
    {num: 1, cash: gameState.teams[1].cash, color: '#E94235', textColor: '#fff'},
    {num: 2, cash: gameState.teams[2].cash, color: '#FBBC04', textColor: '#000'},
    {num: 3, cash: gameState.teams[3].cash, color: '#4285F4', textColor: '#fff'},
    {num: 4, cash: gameState.teams[4].cash, color: '#0F9D58', textColor: '#fff'}
  ];
  teams.sort((a, b) => b.cash - a.cash);
  
  const scoreboard = document.getElementById('scoreboard');
  scoreboard.innerHTML = teams.map((t, i) => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#1a1a1a;margin-bottom:6px;border-radius:4px;border-left:4px solid ${t.color}">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="color:#666;font-weight:bold;font-family:'Courier New',monospace">#${i+1}</span>
        <span style="color:${t.color};font-weight:bold;font-family:'Courier New',monospace">TEAM ${t.num}</span>
      </div>
      <span style="color:${t.cash >= 0 ? '#0F9D58' : '#E94235'};font-weight:bold;font-family:'Courier New',monospace">$${t.cash.toLocaleString()}</span>
    </div>
  `).join('');
  
  document.getElementById('currentRound').textContent = gameState.round;
  document.getElementById('maxRounds').textContent = gameState.maxRounds;
}

function calculateRevenue() {
  const tv = getTeamTicketValues();
  const destinations = {};
  const results = [];
  
  for (let i = 1; i <= 4; i++) {
    const dest = document.getElementById(`dest${i}`).value;
    const actualDest = dest || gameState.teams[i].city;
    
    if (actualDest && actualDest !== 'start') {
      if (!destinations[actualDest]) destinations[actualDest] = [];
      destinations[actualDest].push({team: i, value: tv[i][actualDest]});
      gameState.teams[i].city = actualDest;
    }
  }
  
  Object.keys(destinations).forEach(cityKey => {
    const teams = destinations[cityKey];
    const pop = cityData[cityKey].pop;
    const cityName = cityData[cityKey].name;
    
    teams.sort((a, b) => b.value - a.value);
    
    // Determine ideal splits based on competition
    let idealSplits;
    if (teams.length === 1) {
      idealSplits = [1.0];
    } else if (teams.length === 2) {
      if (teams[0].value === teams[1].value) {
        idealSplits = [0.5, 0.5];
      } else {
        idealSplits = [0.6, 0.4];
      }
    } else if (teams.length === 3) {
      if (teams[0].value === teams[1].value && teams[1].value === teams[2].value) {
        idealSplits = [0.333, 0.333, 0.334];
      } else if (teams[0].value === teams[1].value) {
        idealSplits = [0.45, 0.45, 0.1];
      } else if (teams[1].value === teams[2].value) {
        idealSplits = [0.6, 0.2, 0.2];
      } else {
        idealSplits = [0.6, 0.3, 0.1];
      }
    } else {
      if (teams[0].value === teams[1].value && teams[1].value === teams[2].value && teams[2].value === teams[3].value) {
        idealSplits = [0.25, 0.25, 0.25, 0.25];
      } else if (teams[0].value === teams[1].value && teams[2].value === teams[3].value) {
        idealSplits = [0.4, 0.4, 0.1, 0.1];
      } else if (teams[0].value === teams[1].value) {
        idealSplits = [0.4, 0.4, 0.1, 0.1];
      } else if (teams[1].value === teams[2].value) {
        idealSplits = [0.6, 0.166, 0.166, 0.068];
      } else if (teams[2].value === teams[3].value) {
        idealSplits = [0.6, 0.2, 0.1, 0.1];
      } else {
        idealSplits = [0.6, 0.2, 0.1, 0.1];
      }
    }
    
    const cityResult = {
      city: cityName,
      population: pop,
      teams: []
    };
    
    teams.forEach((t, idx) => {
      const teamNum = t.team;
      
      // Initialize this team's tracking for this city if needed
      if (!gameState.teams[teamNum].soldTo[cityKey]) {
        gameState.teams[teamNum].soldTo[cityKey] = 0;
      }
      
      // How much has THIS TEAM already sold to in this city?
      const teamAlreadySold = gameState.teams[teamNum].soldTo[cityKey];
      
      // This team's ideal share this round based on competition
      const idealShare = idealSplits[idx];
      
      // This team can get UP TO their ideal share, but only from people they haven't sold to yet
      const teamCanStillSellTo = 1.0 - teamAlreadySold; // Remaining market for THIS team
      const actualShare = Math.min(idealShare, teamCanStillSellTo);
      
      const revenue = Math.round(pop * t.value * actualShare);
      gameState.teams[teamNum].cash += revenue;
      
      // Update what % of city this team has now sold to
      gameState.teams[teamNum].soldTo[cityKey] += actualShare;
      
      cityResult.teams.push({
        teamNum: teamNum,
        ticketPrice: t.value,
        idealShare: idealShare,
        actualShare: actualShare,
        teamAlreadySold: teamAlreadySold,
        teamCanStillSellTo: teamCanStillSellTo,
        revenue: revenue
      });
    });
    
    results.push(cityResult);
  });
  
  return results;
}

function nextRound() {
  if (gameState.round > gameState.maxRounds) {
    alert('Game Over! Check final scores.');
    return;
  }
  
  const currentRound = gameState.round;
  const results = calculateRevenue();
  
  // Create results popup
  const teamColors = {
    1: {bg: '#E94235', text: '#fff'},
    2: {bg: '#FBBC04', text: '#000'},
    3: {bg: '#4285F4', text: '#fff'},
    4: {bg: '#0F9D58', text: '#fff'}
  };
  
  let popupContent = `
    <div style="background:#fff;padding:0;border-radius:8px;max-width:700px;width:95%;max-height:90vh;overflow:auto">
      <div style="background:#000;color:#fff;padding:20px;position:sticky;top:0;z-index:10">
        <h2 style="margin:0;font-size:1.5rem;font-family:'Courier New',monospace">Round ${currentRound} Results</h2>
      </div>
      <div style="padding:20px">
  `;
  
  if (results.length === 0) {
    popupContent += '<p style="text-align:center;color:#666;padding:40px">All teams stayed at START (no revenue)</p>';
  } else {
    results.forEach(cityResult => {
      popupContent += `
        <div style="margin-bottom:30px;border:2px solid #000;border-radius:4px;overflow:hidden">
          <div style="background:#000;color:#fff;padding:12px 15px;font-weight:bold;font-family:'Courier New',monospace">
            ${cityResult.city} - Population: ${(cityResult.population / 1000000).toFixed(1)}M
          </div>
          <div style="padding:15px">
      `;
      
      cityResult.teams.forEach(team => {
        const color = teamColors[team.teamNum];
        const soldOut = team.actualShare === 0;
        const partial = team.teamAlreadySold > 0;
        
        popupContent += `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;margin-bottom:8px;background:${soldOut ? '#fff5f5' : '#f5f5f5'};border-left:4px solid ${color.bg}">
            <div style="display:flex;align-items:center;gap:15px;flex:1">
              <div style="background:${color.bg};color:${color.text};padding:6px 12px;border-radius:4px;font-weight:bold;font-size:0.9rem;min-width:80px;text-align:center">
                TEAM ${team.teamNum}
              </div>
              <div style="font-family:'Courier New',monospace">
                <div style="font-size:0.85rem;color:#666">Ticket Price</div>
                <div style="font-size:1.1rem;font-weight:bold">$${team.ticketPrice}</div>
              </div>
            </div>
            <div style="display:flex;gap:20px;align-items:center">
              <div style="text-align:right">
                <div style="font-size:0.85rem;color:#666">Market Share</div>
                <div style="font-size:1.1rem;font-weight:bold;color:${soldOut ? '#E94235' : color.bg}">
                  ${Math.round(team.actualShare * 100)}%${soldOut ? ' (SOLD OUT)' : ''}
                </div>
                ${partial ? `<div style="font-size:0.75rem;color:#999">Already sold to: ${Math.round(team.teamAlreadySold * 100)}% | Remaining: ${Math.round(team.teamCanStillSellTo * 100)}%</div>` : ''}
              </div>
              <div style="text-align:right;min-width:120px">
                <div style="font-size:0.85rem;color:#666">Revenue</div>
                <div style="font-size:1.2rem;font-weight:bold;color:${soldOut ? '#E94235' : '#0F9D58'}">$${team.revenue.toLocaleString()}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      popupContent += '</div></div>';
    });
  }
  
  popupContent += `
        <button id="closeResultsBtn" style="width:100%;padding:15px;background:#000;color:#fff;border:none;font-weight:bold;font-size:1rem;cursor:pointer;margin-top:10px">
          CONTINUE
        </button>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = popupContent;
  
  document.body.appendChild(modal);
  
  document.getElementById('closeResultsBtn').addEventListener('click', () => {
    document.body.removeChild(modal);
  });
  
  // Update log
  const logDiv = document.getElementById('logEntries');
  const logEntries = results.flatMap(cr => 
    cr.teams.map(t => `Team ${t.teamNum} in ${cr.city}: $${t.revenue.toLocaleString()} (${Math.round(t.marketShare*100)}%)`)
  );
  logDiv.innerHTML = `<div class="log-entry"><strong>Round ${currentRound}:</strong></div>` + 
    logEntries.map(l => `<div class="log-entry">${l}</div>`).join('') + logDiv.innerHTML;
  
  gameState.round++;
  drawTeams();
  populateDestinationDropdowns();
  updateTeamDisplay();
  
  if (gameState.round > gameState.maxRounds) {
    let winner = 1;
    for (let i = 2; i <= 4; i++) {
      if (gameState.teams[i].cash > gameState.teams[winner].cash) winner = i;
    }
    logDiv.innerHTML = `<div class="log-entry" style="color:#0F9D58"><strong>GAME OVER! Team ${winner} wins with $${gameState.teams[winner].cash.toLocaleString()}!</strong></div>` + logDiv.innerHTML;
  }
}


function saveGame() {
  const saveData = {
    version: '1.0',
    timestamp: new Date().toISOString(),
    gameState: gameState,
    artworkAssignments: []
  };
  
  // Capture all artwork assignments
  document.querySelectorAll('.art-card').forEach(card => {
    const idx = parseInt(card.dataset.idx);
    const team = card.dataset.team;
    if (team) {
      const teamNum = parseInt(team.replace('TEAM ', ''));
      const artwork = gameState.teams[teamNum].artworks.find(a => a.idx === idx);
      if (artwork) {
        saveData.artworkAssignments.push({
          idx: idx,
          team: teamNum,
          price: artwork.price
        });
      }
    }
  });
  
  // Convert to JSON
  const jsonString = JSON.stringify(saveData, null, 2);
  
  // Create download
  const blob = new Blob([jsonString], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `art-for-all-save-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert('Game saved! File downloaded.');
}

function loadGame() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const saveData = JSON.parse(event.target.result);
        
        if (!saveData.version || !saveData.gameState) {
          alert('Invalid save file format');
          return;
        }
        
        // Restore game state
        gameState = saveData.gameState;
        
        // Clear all current assignments
        document.querySelectorAll('.team-badge-container').forEach(container => {
          container.innerHTML = '';
        });
        document.querySelectorAll('.art-card').forEach(card => {
          delete card.dataset.team;
        });
        
        // Restore artwork assignments
        saveData.artworkAssignments.forEach(assignment => {
          const card = document.querySelector(`.art-card[data-idx="${assignment.idx}"]`);
          if (!card) return;
          
          card.dataset.team = 'TEAM ' + assignment.team;
          
          const container = card.querySelector('.team-badge-container');
          container.innerHTML = `
            <div class="team-badge team-${assignment.team}">
              <span>TEAM ${assignment.team}</span>
              <span class="remove" data-idx="${assignment.idx}" data-team="${assignment.team}">Ã—</span>
            </div>
          `;
          
          // Add remove handler
          container.querySelector('.remove').addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('Remove this artwork from Team ' + assignment.team + '?')) {
              const artIdx = gameState.teams[assignment.team].artworks.findIndex(a => a.idx === assignment.idx);
              if (artIdx !== -1) {
                const artwork = gameState.teams[assignment.team].artworks[artIdx];
                gameState.teams[assignment.team].cash += artwork.price;
                gameState.teams[assignment.team].artworks.splice(artIdx, 1);
              }
              container.innerHTML = '';
              delete card.dataset.team;
              updateTeamDisplay();
              updateCompetitiveAnalysis();
            }
          });
        });
        
        // Update displays
        drawTeams();
        populateDestinationDropdowns();
        updateTeamDisplay();
        updateCompetitiveAnalysis();
        
        // Restore game log
        const logDiv = document.getElementById('logEntries');
        logDiv.innerHTML = '';
        
        alert(`Game loaded! Round ${gameState.round} of ${gameState.maxRounds}`);
        
      } catch (error) {
        alert('Error loading save file: ' + error.message);
      }
    };
    
    reader.readAsText(file);
  });
  
  input.click();
}

function resetGame() {
  gameState = {
    round: 1,
    maxRounds: parseInt(document.getElementById('totalRounds').value) || 8,
    teams: {
      1: {cash: 0, city: 'start', artworks: [], soldTo: {}},
      2: {cash: 0, city: 'start', artworks: [], soldTo: {}},
      3: {cash: 0, city: 'start', artworks: [], soldTo: {}},
      4: {cash: 0, city: 'start', artworks: [], soldTo: {}}
    }
  };
  document.getElementById('logEntries').innerHTML = '';
  for (let i = 1; i <= 4; i++) {
    document.getElementById(`dest${i}`).value = '';
  }
  document.querySelectorAll('.team-badge-container').forEach(container => {
    container.innerHTML = '';
  });
  document.querySelectorAll('.art-card').forEach(card => {
    delete card.dataset.team;
  });
  drawTeams();
  populateDestinationDropdowns();
  updateTeamDisplay();
  updateCompetitiveAnalysis();
}

document.getElementById('mapBtn').addEventListener('click', () => {
  document.getElementById('mapModal').classList.add('show');
  gameState.maxRounds = parseInt(document.getElementById('totalRounds').value) || 8;
  initMap();
  populateDestinationDropdowns();
  updateTeamDisplay();
  updateCompetitiveAnalysis();
});

document.getElementById('mapClose').addEventListener('click', () => {
  document.getElementById('mapModal').classList.remove('show');
});

document.getElementById('nextRound').addEventListener('click', nextRound);
document.getElementById('resetGame').addEventListener('click', resetGame);
document.getElementById('saveGame').addEventListener('click', saveGame);
document.getElementById('loadGame').addEventListener('click', loadGame);

document.getElementById('totalRounds').addEventListener('change', (e) => {
  gameState.maxRounds = parseInt(e.target.value) || 8;
  updateTeamDisplay();
});

for (let i = 1; i <= 4; i++) {
  document.getElementById(`dest${i}`).addEventListener('change', updateTeamDisplay);
}

initGallery();
updateCompetitiveAnalysis();
</script>
</body>
</html>
